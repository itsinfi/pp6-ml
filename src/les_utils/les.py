import dawdreamer as daw
import laion_clap as lc
import numpy as np
from clap_utils import init_clap, create_embeddings
from dawdreamer_utils import init_dawdreamer, render_patch
import pandas as pd
from typing import Dict
from diva import array_to_patch
import json
import jax
import jax.numpy as jnp
from evosax.algorithms import LearnedES

clap = init_clap()
engine, diva = init_dawdreamer()

def les(
    text_embed: np.ndarray,
    row: Dict,
    clap: lc.CLAP_Module,
    engine: daw.RenderEngine,
    diva: daw.PluginProcessor,
    population_size: int = 25,
    iterations: int = 50,
    param_dim: int = 24
):
    """
    algorithmic optimizer (learned es) for clap text embeddings and audio embeddings based on work from:
    - Lange, R. et al. (2023a): https://arxiv.org/abs/2211.11260
    - Lange, R. (2025): https://pypi.org/project/evosax/
    - Cherep, M. et al. (2024). https://arxiv.org/abs/2406.00294
    """

    # initialize les
    les = LearnedES(population_size, solution=jnp.zeros(param_dim))

    # initialize parameters
    params = les.default_params
    mean = jnp.zeros(param_dim)
    
    # initialize state
    key = jax.random.key(0)
    state = les.init(key, mean, params)

    for i in range(1, iterations + 1):
        print(f'iteration {i}/{iterations}')

        # generate canidates
        key, key_ask, key_tell = jax.random.split(key, 3)
        population, state = les.ask(key_ask, state, params)

        # reshape with sigmoid function to value range
        population = jax.nn.sigmoid(population)

        # reshape to dataframe
        df_canidates = pd.DataFrame([{
            **array_to_patch(canidate),
            'meta_name': row['meta_name'], 
            'meta_location': row['meta_location'],
            'tags_categories': row['tags_categories'],
            'tags_features': row['tags_features'],
            'tags_character': row['tags_character'],
        } for canidate in np.array(population)])
        
        # synthesize audio + get audio embedding
        audio_embeds = []
        for idx, canidate in df_canidates.iterrows():
            dataset_name = f'temp_{idx}'
            render_patch(canidate, engine, diva, dataset_name)
            canidate_with_embeds = create_embeddings(canidate, clap, dataset_name)
            audio_embeds.append(np.array(
                json.loads(canidate_with_embeds['embeddings_audio']),
                dtype=np.float32,
            ))

        # compute fitness (negative cosine similarity between audio and text embeddings)
        fitness = jnp.array(
            -np.dot(audio_embeds, text_embed) / (
                np.linalg.norm(audio_embeds, axis=1) * 
                np.linalg.norm(text_embed) + 1e-8
            ),
            dtype=jnp.float32,
        )

        # update optimizer state
        state, _ = les.tell(key_tell, population, fitness, state, params)
    
    # return optimal patch
    print(f'best fitness: {state.best_fitness}')
    print(f'{state.best_solution}')
    return state.best_solution

# les(
#     text_embed=np.array([-0.019968707114458084, -0.004541655536741018, -0.028538472950458527, -0.02812005952000618, 0.016956200823187828, 0.06408907473087311, 0.04294522479176521, 0.04599466919898987, -0.058037374168634415, -0.05177094414830208, -0.002195723121985793, 0.012789278291165829, -0.0361335352063179, -0.05834927782416344, -0.05089500918984413, 0.006518528796732426, 0.10273704677820206, -0.019030781462788582, 0.0474737286567688, -0.02496141567826271, -0.08588971942663193, 0.015161408111453056, 0.005703965201973915, -0.014778601936995983, -0.016175881028175354, 0.044747281819581985, -0.03357679396867752, 0.014353717677295208, 0.032376259565353394, 0.0439431257545948, -0.030492156744003296, -0.07580482959747314, -0.05563777685165405, -0.026902591809630394, 0.03400777652859688, 0.05446404591202736, -0.052636004984378815, -0.020317263901233673, 0.02446720190346241, 0.033502474427223206, 0.09551862627267838, -0.05552232638001442, -0.030165106058120728, -0.03864108771085739, -0.02235412783920765, 0.03119540773332119, 0.054305851459503174, 0.0863361805677414, -0.03405404090881348, -0.06089635193347931, -0.01777738332748413, 0.020522935315966606, 0.0067723155952990055, 0.03627713769674301, -0.05995211377739906, 0.0562172569334507, -0.09612935781478882, 0.045099448412656784, 0.0647270530462265, -0.03814687579870224, -0.061902038753032684, 0.06336010247468948, 0.000922844628803432, 0.0695052444934845, -0.020427221432328224, 0.11821772903203964, -0.014119893312454224, -0.013142517767846584, 0.05222262814640999, -0.031302884221076965, -0.03233959525823593, -0.029856327921152115, -0.011924474500119686, 0.016119180247187614, 0.008809072896838188, -0.06180231273174286, 0.05566505715250969, 0.003218608908355236, -0.0041373902931809425, -0.04581640288233757, -0.01591867208480835, -0.10213858634233475, 0.03431930020451546, -0.013328426517546177, -0.04484660550951958, 0.05146627500653267, -0.023202842101454735, -0.07209379225969315, 0.04947730898857117, 0.06420864909887314, 0.01555191446095705, -0.065691739320755, -0.08089929074048996, 0.0666428655385971, 0.06737638264894485, -0.029983799904584885, 0.05857013165950775, -0.06982729583978653, -0.05965663865208626, 0.12938056886196136, 0.01148318499326706, 0.048077117651700974, -0.0654458999633789, 0.006793384440243244, 0.019783958792686462, -0.017246084287762642, -0.003142314264550805, -0.02776252292096615, 0.03576014190912247, -0.07427562028169632, 0.012701288796961308, -0.05113754794001579, 0.08059527724981308, 0.006462618242949247, -0.015120347961783409, 0.04493946209549904, -0.005209944676607847, 0.02325679361820221, 0.01912882551550865, 0.043883029371500015, 0.058494389057159424, 0.013556362129747868, -0.030161675065755844, 0.05999811366200447, -0.007752669509500265, -0.03317492455244064, 0.005403520073741674, -0.04820564016699791, -0.00555248511955142, -0.04389050975441933, 0.004485575947910547, -0.07164863497018814, -0.03588138893246651, 0.05378755182027817, -0.01650121808052063, -0.0036007228773087263, 0.01059923879802227, -0.004241785500198603, 0.04029037058353424, -0.01595102995634079, -0.03710459917783737, 0.026317022740840912, -0.00783195998519659, -0.044431526213884354, 0.006663392297923565, -0.08918379247188568, 0.03268000856041908, -0.04632895067334175, 0.026801537722349167, -0.006518026813864708, 0.0003349624457769096, 0.0053876591846346855, 0.024017643183469772, -0.035297464579343796, 0.03147454932332039, -0.001076399814337492, 0.03854258358478546, -0.0715634748339653, -0.03905012086033821, -0.0962177962064743, -0.022966407239437103, -0.03501702472567558, 0.026139236986637115, -0.04294077306985855, 0.0192768182605505, -0.08471120148897171, -0.032233983278274536, -0.02771763689815998, 0.042251136153936386, 0.0006679288344457746, 0.07618658989667892, 0.017958233132958412, -0.03946784511208534, -0.07169587910175323, -0.03398783132433891, -0.02727777138352394, 0.03595348447561264, -0.0035196903627365828, -0.00931030884385109, -0.012694258242845535, 0.022485898807644844, -0.052373796701431274, 0.003070041537284851, 0.04215723276138306, 0.07277228683233261, -0.017049500718712807, 0.004823900293558836, -0.008527127094566822, 0.07305984944105148, -0.024633850902318954, 0.055089592933654785, 0.021020207554101944, 0.005878307856619358, 0.015827026218175888, 0.05304570868611336, 0.0028555227909237146, 0.03869541734457016, 0.06881694495677948, 0.0019476450979709625, 0.04100845754146576, 0.06164868548512459, -0.04004823789000511, -0.007040454540401697, -0.043614841997623444, -0.05493730679154396, 0.05999751389026642, -0.0519956611096859, -0.016102436929941177, -0.02881375141441822, -0.07076304405927658, -0.005470925476402044, 0.026555661112070084, 0.047161780297756195, -0.08862067759037018, 0.0042113312520086765, -0.03910304978489876, -0.03049904853105545, -0.0706215649843216, 0.019261755049228668, 0.05898819491267204, 0.04040185734629631, -0.033115457743406296, -0.03796457499265671, -0.045955076813697815, 7.861149242671672e-06, 0.02514471299946308, 0.037482600659132004, 0.02589704841375351, -0.05558409169316292, 0.005659540183842182, -0.03345688432455063, 0.012248747050762177, 0.020885508507490158, -0.09395832568407059, 0.02356601133942604, 0.012270907871425152, -0.015167397446930408, -0.03247726708650589, -0.033099912106990814, 0.027488522231578827, 0.053659215569496155, 0.0013305388856679201, 0.03491850942373276, 0.015136304311454296, 0.017405617982149124, -0.004284357186406851, 0.01941213198006153, -0.027289623394608498, -0.0432574562728405, -0.03199634328484535, 0.027706898748874664, 0.028916846960783005, -0.014072667807340622, 0.0526442788541317, -0.02466433495283127, 0.05920029059052467, -0.05195778235793114, 0.03197519853711128, -0.0004417054879013449, 0.024211809039115906, -0.07007671147584915, 0.0117418197914958, 0.053813375532627106, -0.03955458477139473, -0.0646577775478363, -0.08303173631429672, -0.030035316944122314, 0.08981301635503769, 0.093883216381073, 0.0007655032677575946, 0.041532982140779495, -0.03824155032634735, 0.015269757248461246, 0.06907644122838974, -0.059052981436252594, -0.024871567264199257, 0.03288697451353073, -0.0017569804331287742, 0.0020293721463531256, -0.016628742218017578, 0.038689881563186646, 0.027495888993144035, -0.008941056206822395, -0.06486012786626816, 0.043818265199661255, -0.026925094425678253, -0.021603519096970558, -0.022671720013022423, 0.023488417267799377, 0.006604854017496109, 0.033410247415304184, 0.01614776998758316, -0.024515610188245773, 0.002969153691083193, -0.01497100293636322, 0.021432917565107346, 0.07711585611104965, -0.04261279106140137, 0.0557713620364666, -0.03085005283355713, 0.012492944486439228, -0.0013805263442918658, -0.004991187714040279, -0.0013460519257932901, 0.0035375875886529684, -0.05794621258974075, -0.08071665465831757, 0.029319804161787033, -0.059970736503601074, 0.04719306901097298, 0.0025203959085047245, 0.04943062737584114, 0.0648864209651947, -0.015453934669494629, 0.04927689582109451, 0.02353009767830372, 0.009187242016196251, 0.050793372094631195, -0.000461483170511201, -0.007566983345896006, -0.07508345693349838, -0.029589014127850533, 0.012279197573661804, -0.0663166418671608, 0.07215740531682968, -0.012929819524288177, -0.0011427951976656914, -0.014654312282800674, -0.07475180178880692, 0.12479496002197266, 0.06145288795232773, 0.10332094877958298, -0.0002323682128917426, -0.09337056428194046, -0.021307067945599556, -0.07440558075904846, 0.04728539660573006, 0.026599934324622154, 0.048446282744407654, 0.09186477214097977, -0.049266573041677475, -0.046678557991981506, 0.010170788504183292, 0.01208772324025631, 0.025319546461105347, 0.034948792308568954, 0.08030365407466888, 0.07872547209262848, 0.10292551666498184, -0.033905208110809326, -0.049540843814611435, -0.010388669557869434, -0.02072942815721035, 0.01837410405278206, -0.003404631745070219, 0.019089343026280403, 0.0049661267548799515, -0.009752705693244934, -0.045546211302280426, 0.07942581176757812, -0.0449729822576046, -0.005253439769148827, 0.027782445773482323, -0.048940833657979965, -0.019276168197393417, -0.030046731233596802, -0.027658268809318542, -0.03828337788581848, 0.016835719347000122, -0.022223467007279396, -0.0069041782990098, 0.023834053426980972, -0.020385796204209328, -0.03091970458626747, 0.01776721701025963, -0.021877983585000038, -0.04525244981050491, -0.04958438500761986, -0.04345542937517166, -0.04343272000551224, 0.019295401871204376, 0.03688675910234451, 0.03217427432537079, -0.04118200019001961, -0.02746470458805561, -0.04826243221759796, 0.0442320853471756, -0.002063474152237177, 0.024210060015320778, 0.1306896060705185, 0.008509531617164612, -0.01851351000368595, 0.021247999742627144, 0.07348541170358658, -0.002646666020154953, 0.019140906631946564, -0.03237539157271385, -0.0034808162599802017, 0.008819676004350185, -0.06356030702590942, -0.007602638099342585, -0.009658010676503181, -0.04390399158000946, -0.014698639512062073, -0.007225570268929005, -0.1122601255774498, -0.012158311903476715, 0.016373325139284134, 0.04254203662276268, 0.01830279268324375, -0.06431673467159271, -0.07670613378286362, 0.03865160793066025, -0.07425790280103683, -0.02325129508972168, 0.049579180777072906, 0.0483834333717823, 0.019183319061994553, 0.033543214201927185, -0.007794116158038378, -0.11615919321775436, -0.018685711547732353, -0.05901745706796646, 0.07344727218151093, -0.01279482152312994, 0.09444209188222885, -0.10359462350606918, -0.04688026010990143, -0.02659233659505844, 0.01930617354810238, -0.03683361038565636, 0.009946069680154324, 0.09254280477762222, -0.044982992112636566, 0.03286879509687424, -0.022327333688735962, 0.035054948180913925, 0.04493505880236626, 0.02094361186027527, -0.0020441499073058367, -0.009154731407761574, -0.027700748294591904, 0.09074119478464127, -0.021260350942611694, 0.004153159912675619, -0.01055110339075327, -0.06376107782125473, -0.05323227494955063, -0.007326644845306873, 0.008700322359800339, -0.08221246302127838, 0.020649578422307968, -0.016321826726198196, 0.009731581434607506, -0.031451139599084854, 0.055270157754421234, 0.007148489356040955, -0.05037633702158928, 0.04935562610626221, -0.014355169609189034, 0.0470515638589859, 0.05219927057623863, -0.006518930662423372, -0.05066149681806564, -0.04671105369925499, 0.024168290197849274, -0.02493700385093689, 0.04341001808643341, 0.011178070679306984, 0.04862665757536888, -0.039484091103076935, 0.008775283582508564, 0.005013095214962959, 0.022961869835853577, -0.004187472630292177, -0.06745807826519012, -0.004107638727873564, 0.021390220150351524, -0.009188232943415642, 0.00024065873003564775, 0.004253705032169819, -0.014781801961362362, -0.05974069610238075, 0.00013722253788728267, -0.0049031381495296955, 0.04745674878358841, -0.0066896043717861176, 0.04357343167066574, 0.02570239268243313, 0.044391244649887085, 0.010586387477815151, 0.10240696370601654, 0.002196833025664091, -0.03808051720261574, -0.04255582392215729, -0.008552717976272106, -0.06613080203533173, 0.01399209350347519, -0.0426064059138298, 0.04350683093070984, -0.009843315929174423, 0.029355881735682487, -0.04262450709939003, -0.06536833941936493, -0.014843761920928955, 0.008566319942474365, -0.019361956045031548, -0.05510934814810753, 0.06160159036517143, 0.04763491079211235, -0.00904011633247137, -0.04891379550099373]),
#     row={
#         'meta_name': 'HS CongoBongo',
#         'meta_location': '\\5 percussive\hs congobongo.h2p',
#         'tags_categories': 'Drums:Percussion',
#         'tags_features': 'Poly, CrossMod, Percussive',
#         'tags_character': 'Dirty, Thin',
#         'env_1_attack,': 0.0,
#         'env_1_decay,': 0.285,
#         'env_1_sustain,': 0.0,
#         'env_1_release,': 0.3,
#         'env_1_velocity,': 0.0,
#         'env_1_model_ads,': 1.0,
#         'env_1_model_analogue,': 0.0,
#         'env_1_model_digital,': 0.0,
#         'env_1_quantize,': 0.0,
#         'env_1_curve,': 0.0,
#         'env_1_release_on,': 1.0,
#         'env_1_key_follow,': 0.9,
#         'env_2_attack,': 0.02,
#         'env_2_decay,': 0.26,
#         'env_2_sustain,': 0.0,
#         'env_2_release,': 0.57,
#         'env_2_velocity,': 0.87,
#         'env_2_model_ads,': 0.0,
#         'env_2_model_analogue,': 1.0,
#         'env_2_model_digital,': 0.0,
#         'env_2_quantize,': 0.0,
#         'env_2_curve,': 1.0,
#         'env_2_release_on,': 0.0,
#         'env_2_key_follow,': 0.33,
#     },
#     clap=clap,
#     engine=engine,
#     diva=diva,
# )